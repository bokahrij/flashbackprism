name: Build Android APK 4

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Choose build type'
        required: true
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug
      qt_version:
        description: 'Qt version to use'
        required: true
        default: '6.9.3'
      android_api:
        description: 'Android API Level'
        required: true
        default: '33'
      android_ndk:
        description: 'Android NDK version'
        required: true
        default: '25.2.9519653'

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Qt Android
      uses: jurplel/install-qt-action@v2
      with:
        version: ${{ github.event.inputs.qt_version }}
        target: android

    - name: Install Android SDK & NDK
      run: |
        sudo apt update
        sudo apt install -y zlib1g-dev libc6-dev
        mkdir -p $HOME/Android/Sdk
        export ANDROID_SDK_ROOT=$HOME/Android/Sdk
        sdkmanager --install "platforms;android-${{ github.event.inputs.android_api }}" \
                     "build-tools;${{ github.event.inputs.android_api }}.0.2" \
                     "ndk;${{ github.event.inputs.android_ndk }}"

    - name: Configure Build
      run: |
        mkdir android-build
        cd android-build
        $HOME/Qt/${{ github.event.inputs.qt_version }}/android/bin/qt-cmake ..

    - name: Compile
      run: |
        cd android-build
        make -j$(nproc)

    - name: Deploy APK
      run: |
        cd android-build
        BUILD_TYPE=$(echo "${{ github.event.inputs.build_type }}" | tr '[:upper:]' '[:lower:]')
        $HOME/Qt/${{ github.event.inputs.qt_version }}/android/bin/androiddeployqt \
          --input android-build/android-libflashbackprism.so-deployment-settings.json \
          --output android-apk \
          --$BUILD_TYPE \
          --sign

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: FlashbackPrism-APK
        path: android-build/android-apk/*.apk
