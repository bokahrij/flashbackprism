name: Build Android APK 4

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Choose build type'
        required: true
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug
      android_api:
        description: 'Android API Level'
        required: true
        default: '33'
      android_ndk:
        description: 'Android NDK version'
        required: true
        default: '25.2.9519653'

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.14'

    - name: Install aqtinstall
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install aqtinstall==1.2.5

    - name: Find latest Qt Android version
      id: listqt
      run: |
        AVAILABLE=$(python3 -m aqt list-qt linux android | tr ' ' '\n' | grep '^6\.' | sort -Vr | head -n1)
        echo "latest_android_qt=$AVAILABLE" >> $GITHUB_OUTPUT
        echo "Latest Qt for Android: $AVAILABLE"

    - name: Install Qt Android
      run: |
        python3 -m aqt install 6.6.0 linux android \
          --arch android_arm64_v8a \
          --outputdir $HOME/Qt

    - name: Install Android SDK & NDK
      run: |
        sudo apt update
        sudo apt install -y openjdk-11-jdk wget unzip
        mkdir -p $HOME/Android/Sdk
        export ANDROID_SDK_ROOT=$HOME/Android/Sdk
        wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
        unzip cmdline-tools.zip -d $HOME/Android/Sdk
        mv $HOME/Android/Sdk/cmdline-tools $HOME/Android/Sdk/tools
        yes | $HOME/Android/Sdk/tools/bin/sdkmanager --licenses
        $HOME/Android/Sdk/tools/bin/sdkmanager "platforms;android-${{ github.event.inputs.android_api }}" \
                                               "build-tools;${{ github.event.inputs.android_api }}.0.2" \
                                               "ndk;${{ github.event.inputs.android_ndk }}"

    - name: Configure Build
      run: |
        mkdir android-build
        cd android-build
        $HOME/Qt/${{ steps.listqt.outputs.latest_android_qt }}/android/bin/qt-cmake ..

    - name: Compile
      run: |
        cd android-build
        make -j$(nproc)

    - name: Deploy APK
      run: |
        cd android-build
        BUILD_TYPE=$(echo "${{ github.event.inputs.build_type }}" | tr '[:upper:]' '[:lower:]')
        $HOME/Qt/${{ steps.listqt.outputs.latest_android_qt }}/android/bin/androiddeployqt \
          --input android-build/android-libflashbackprism.so-deployment-settings.json \
          --output android-apk \
          --$BUILD_TYPE \
          --sign

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: FlashbackPrism-APK
        path: android-build/android-apk/*.apk
